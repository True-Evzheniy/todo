<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToDo</title>
    <style>
        input:checked + input {
            text-decoration: line-through;
        }

        input:checked + input:focus {
            text-decoration: none;
        }

        .task__list .task__input {
            border-color: transparent;
        }

        .task--focused .task__input {
            border-color: initial;
        }

        .task__save {
            visibility: hidden;
        }

        .task--focused .task__save {
            visibility: visible;
        }

        .task--focused .task__add {
            visibility: visible;
        }

        .task--focused .task__clear {
            visibility: visible;
        }

        .task__clear {
            visibility: hidden;
        }

        .task__add {
            visibility: hidden;
        }



    </style>
</head>
<body>
<div class="task__list">

</div>
<div class="task__adder">
    <div class="task">
        <input type="checkbox" class="task__check">
        <input type="text" class="task__input">
        <button class="task__add">V</button>
        <button class="task__clear">X</button>
    </div>
</div>
<div class="task__filter">
    <input type="radio" name="filter" id="all" checked><label for="all">Все</label>
    <input type="radio" name="filter" id="complete"><label for="complete">Выполненные</label>
    <input type="radio" name="filter" id="active"><label for="active">Активные</label>
</div>
<template style="dispaly: none">
    <div class="task">
        <input type="checkbox" class="task__check">
        <input type="text" class="task__input">
        <button class="task__save">V</button>
        <button class="task__remove">X</button>
    </div>
</template>
<script>
    'use strict';
    (function() {
        var taskTemplate = getTaskTemplate();
        var taskList = document.querySelector('.task__list');
        var adder = document.querySelector('.task__adder');
        var taskFilter = document.querySelector('.task__filter');
        var data = [{id: 1, text: 'купить хлеб', checked: true},
            {id: 2, text: 'покрасить небо', checked: false},
            {id: 3, text: 'съесть французских булок', checked: true}];

        taskList.addEventListener('click', removeTaskHandler );

        //on('click', taskList, 'task__remove', removeTaskHandler);

        taskList.addEventListener('click', saveEditingTaskHandler );

        taskList.addEventListener('click', checkTaskHandler);

        taskList.addEventListener('blur', revertValueTaskOfBlurHandler, true);

        taskList.addEventListener('focus', addClassFocusHandler, true);

        adder.addEventListener('click', addNewTaskHandler);

        adder.addEventListener('click', clearInputFieldHandler);

        taskFilter.addEventListener('click', showFilteredTaskHandler);

        adder.addEventListener('focus', addClassFocusHandler, true);

        adder.addEventListener('blur', removeClassFocusHandler, true);


        // HANDLERS
        function removeTaskHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__remove')) {
                target = getParentByClassName(target, 'task');
                deleteTask(target.id);
                renderTaskList(data);
            }
        }

        function saveEditingTaskHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__save')) {
                target = getParentByClassName(target, 'task');
                var checkbox = target.querySelector('.task__check');
                var input = target.querySelector('.task__input');
                editTask(target.id, input.value, checkbox.checked);
                renderTaskList(data);
            }
        }

        function revertValueTaskOfBlurHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__input')) {
                console.log('22');
                setTimeout(function(){renderTaskList(data);}, 150);
            }
        }

        function addClassFocusHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__input')) {
                target = getParentByClassName(target, 'task');
                target.classList.add('task--focused');
            }
        }

        function removeClassFocusHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__input')) {
                target = getParentByClassName(target, 'task');
                setTimeout(function(){target.classList.remove('task--focused')}, 150);
            }
        }

        function showFilteredTaskHandler() {
            renderTaskList(data);
        }

        function addNewTaskHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__add')) {
                target = getParentByClassName(target, 'task');
                var checkbox = target.querySelector('.task__check');
                var input = target.querySelector('.task__input');
                if (input) {
                    addTask(input.value, checkbox.checked);
                    input.value = '';
                    renderTaskList(data);
                }
            }
        }

        function clearInputFieldHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__clear')) {
                target = getParentByClassName(target, 'task');
                var input = target.querySelector('.task__input');
                input.value = '';
            }
        }

        //FUNCTIONS
        function getTaskNode(taskData) {
            var task = taskTemplate.cloneNode(true);
            task.id = taskData.id;
            var checkbox = task.querySelector('.task__check');
            var text = task.querySelector('.task__input');
            if (taskData.checked) {
                checkbox.checked = true;
            }
            if (taskData.text) {
                text.value = taskData.text;
            }
            return task;
        }

        function getCheckedTasks(arr) {
            return arr.filter(function (item) {
                return item.checked;
            })
        }

        function getNotCheckedTasks(arr) {
            return arr.filter(function (item) {
                return !item.checked;
            })
        }

        function renderTasks(tasksData) {
            var fragment = document.createDocumentFragment();
            tasksData.forEach(function (item) {
                fragment.appendChild(getTaskNode(item));
            });
            taskList.appendChild(fragment);
        }

        function getFilter() {
            var btns = document.querySelectorAll('input[type=radio]');
            var id;
            [].forEach.call(btns, function (item) {
                if (item.checked) id = item.id;
            });
            return id;
        }

        function getFilteredTasks(allTasks, nameFilter) {
            allTasks = allTasks.slice('');
            switch (nameFilter) {
                case 'all':
                    return allTasks;
                case 'complete':
                    return getCheckedTasks(allTasks);
                case 'active':
                    return getNotCheckedTasks(allTasks);
            }
        }

        function renderTaskList(data) {
            taskList.innerHTML = '';
            var filterName = getFilter();
            var filteredTasks = getFilteredTasks(data, filterName);
            console.log('filteredTasks',filteredTasks);
            renderTasks(filteredTasks);
        }

        function deleteTask(id) {
            var newDataArray = data.filter(function (item) {
                return item.id !== +id;
            });
            data = newDataArray;
        }

        function editTask(id, text, checked) {
            data.forEach(function (item) {
                if (item.id === +id) {
                    item.text = text;
                    item.checked = checked;
                }
            })
        }

        function addTask(text, checked) {
            data.push({id: Date.now(), text: text, checked: checked});
        }

        function getParentByClassName(nodeElement, className) {
            while (!nodeElement.classList.contains(className)) {
                nodeElement = nodeElement.parentNode;
            }
            return nodeElement;
        }

        function checkTaskHandler(evt) {
            var target = evt.target;
            if (target.classList.contains('task__check')) {
                target = getParentByClassName(target, 'task');
                var checkbox = target.querySelector('.task__check');
                var input = target.querySelector('.task__input');
                editTask(target.id, input.value, checkbox.checked);
                renderTaskList(data);
            }
        }

        function getTaskTemplate() {
            var template = document.querySelector('template');
            // Если нет поддержки браузером шаблон берем из DOMa
            if ('content' in template) {
                return template.content.firstElementChild;
            } else {
                return template.firstElementChild;
            }
        }

        renderTaskList(data);
    })()
</script>
</body>
</html>
